<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Access Nature</title>
  
  <!-- External CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">
  
  <!-- App CSS -->
  <link rel="stylesheet" href="src/css/base.css">
  <link rel="stylesheet" href="src/css/layout.css">
  <link rel="stylesheet" href="src/css/components.css">
  <link rel="stylesheet" href="src/css/accessibility.css">
  <link rel="stylesheet" href="src/css/themes.css">
  <link rel="stylesheet" href="src/css/auth.css">

  <style>
.top-nav {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 50px;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 12px;
    z-index: 10000;
  }
  .nav-brand {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 700;
    font-size: 1rem;
    color: #111827;
    text-decoration: none;
  }
  .nav-auth-indicator .auth-status {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: #f3f4f6;
    border-radius: 16px;
    font-size: 0.75rem;
  }
  .nav-auth-indicator .auth-status.signed-in {
    background: #dcfce7;
    color: #166534;
  }
  .nav-menu {
    display: flex;
    align-items: center;
    gap: 4px;
    background: transparent;
  }
  .nav-menu .nav-link {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    color: #4b5563;
    text-decoration: none;
    border-radius: 6px;
    font-size: 0.85rem;
  }
  .nav-menu .nav-link:hover { background: #f3f4f6; }
  .nav-menu .nav-link.active { background: #667eea; color: white; }
  .nav-menu .nav-auth .btn {
    padding: 6px 12px;
    border-radius: 6px;
    border: none;
    background: #667eea;
    color: white;
    cursor: pointer;
    font-size: 0.75rem;
  }
  
  /* Hamburger button */
  .menu-toggle {
    display: none;
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    z-index: 10001;
  }
  .hamburger-icon {
    width: 24px;
    height: 18px;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .hamburger-icon span {
    display: block;
    width: 24px;
    height: 3px;
    background: #374151;
    border-radius: 2px;
    transition: all 0.3s ease;
  }
  .menu-toggle.active .hamburger-icon span:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
  }
  .menu-toggle.active .hamburger-icon span:nth-child(2) {
    opacity: 0;
  }
  .menu-toggle.active .hamburger-icon span:nth-child(3) {
    transform: rotate(-45deg) translate(5px, -5px);
  }
  
  /* Offset existing elements for nav */
  #map-container { top: 50px !important; height: calc(100vh - 50px) !important; }
  .top-bar { top: 58px !important; }
  .floating-left { top: 500px !important; }
  .floating-right { top: 475px !important; }
  
  /* Hide old auth bar */
  .auth-status-bar { display: none !important; }
  
  @media (max-width: 768px) {
    .menu-toggle { display: flex !important; }
    .nav-menu {
      display: none;
      background: white;
    }
    .nav-menu.active {
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 50px;
      left: 0;
      right: 0;
      background: white !important;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .nav-menu .nav-link { 
      padding: 14px 16px; 
      width: 100%; 
      font-size: 1rem;
    }
    .nav-menu .nav-auth { width: 100%; margin-top: 8px; }
    .nav-menu .nav-auth .btn { width: 100%; padding: 12px; font-size: 0.9rem; }
  }
  
</style>
</head>
<body>
  <nav class="top-nav">
  <a href="index.html" class="nav-brand">ğŸŒ² Access Nature</a>
  <div class="nav-auth-indicator">
    <div class="auth-status" id="navAuthIndicator">
      <span>ğŸ‘¤</span>
      <span id="navAuthStatusText">Guest</span>
    </div>
  </div>
  <button class="menu-toggle" id="menuToggle">
    <span class="hamburger-icon">
      <span></span>
      <span></span>
      <span></span>
    </span>
  </button>
  <div class="nav-menu" id="navMenu">
    <a href="index.html" class="nav-link">ğŸ  Home</a>
    <a href="tracker.html" class="nav-link active">ğŸ—ºï¸ Track</a>
    <a href="reports.html" class="nav-link">ğŸ“‹ Reports</a>
    <a href="routes.html" class="nav-link">ğŸ“‚ Routes</a>
    <div class="nav-auth">
      <button id="navAuthBtn" class="btn">Sign In</button>
    </div>
  </div>
</nav>

  <!-- Auth Status Bar -->
  <div id="authStatusBar" class="auth-status-bar">
    <div id="userInfo" class="user-info hidden">
      <span class="user-greeting">Welcome, <span id="userEmail"></span>!</span>
      <button id="logoutBtn" class="auth-btn logout-btn">Logout</button>
    </div>
    <div id="authPrompt" class="auth-prompt">
      <button id="showAuthBtn" class="auth-btn login-btn">Sign In</button>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="authModal" class="auth-modal hidden">
    <div class="auth-modal-backdrop" onclick="closeAuthModal()"></div>
    <div class="auth-modal-container">
      <div class="auth-modal-header">
        <h2 id="authModalTitle">Welcome to Access Nature</h2>
        <button class="auth-modal-close" onclick="closeAuthModal()">âœ•</button>
      </div>
      
      <div class="auth-modal-content">
        <!-- Login Form -->
        <div id="loginForm" class="auth-form active">
          <div class="auth-form-header">
            <h3>Sign In to Your Account</h3>
            <p>Continue your accessibility mapping journey</p>
          </div>
          
          <form class="auth-inputs">
            <div class="input-group">
              <input type="email" id="loginEmail" placeholder="Email address" required>
              <span class="input-icon">ğŸ“§</span>
            </div>
            
            <div class="input-group">
              <input type="password" id="loginPassword" placeholder="Password" required>
              <span class="input-icon">ğŸ”’</span>
            </div>
            
            <button type="submit" id="loginBtn" class="auth-submit-btn">
              <span class="btn-text">Sign In</span>
              <span class="btn-spinner hidden">â³</span>
            </button>
          </form>
          
          <div class="auth-divider">
            <span>or</span>
          </div>
          
          <button id="googleLoginBtn" class="google-btn">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIyLjU2IDEyLjI1QzIyLjU2IDExLjQ3IDIyLjQ5IDEwLjcyIDIyLjM2IDEwSDEyVjE0LjI2SDE3LjkyQzE3LjY2IDE1LjYzIDE2Ljg2IDE2Ljc4IDE1LjY2IDE3LjUzVjIwLjM0SDE5LjI4QzIxLjM2IDE4LjQyIDIyLjU2IDE1LjYgMjIuNTYgMTIuMjVaIiBmaWxsPSIjNDI4NUY0Ii8+CjxwYXRoIGQ9Ik0xMiAyM0M5LjExIDIzIDYuNjYgMjEuOTIgNS4xIDIwLjM0TDEuNjUgMTcuNTNDNC42OSAyMC42MSA4LjEyIDIzIDEyIDIzWiIgZmlsbD0iIzM0QTg1MyIvPgo8cGF0aCBkPSJNNS4xIDIwLjM0QzQuMjUgMTkuNTIgMy41OCAxOC40MyAzLjIgMTcuMkgwVjIwLjM0QzAuNDggMjEuMDkgMS4wNCAyMS43NSAxLjY1IDIyLjI4TDUuMSAyMC4zNFoiIGZpbGw9IiNGQkJDMDQiLz4KPHA+" alt="Google" class="google-icon">
            <span>Continue with Google</span>
          </button>
          
          <div class="auth-switch">
            <p>Don't have an account? <button type="button" onclick="switchToSignup()" class="switch-btn">Sign up</button></p>
          </div>
        </div>

        <!-- Signup Form -->
        <div id="signupForm" class="auth-form">
          <div class="auth-form-header">
            <h3>Create Your Account</h3>
            <p>Join the community making nature accessible</p>
          </div>
          
          <form class="auth-inputs">
            <div class="input-group">
              <input type="text" id="signupName" placeholder="Full name" required>
              <span class="input-icon">ğŸ‘¤</span>
            </div>
            
            <div class="input-group">
              <input type="email" id="signupEmail" placeholder="Email address" required>
              <span class="input-icon">ğŸ“§</span>
            </div>
            
            <div class="input-group">
              <input type="password" id="signupPassword" placeholder="Create password" required>
              <span class="input-icon">ğŸ”’</span>
            </div>
            
            <button type="submit" id="signupBtn" class="auth-submit-btn">
              <span class="btn-text">Create Account</span>
              <span class="btn-spinner hidden">â³</span>
            </button>
          </form>
          
          <div class="auth-divider">
            <span>or</span>
          </div>
          
          <button id="googleSignupBtn" class="google-btn">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIyLjU2IDEyLjI1QzIyLjU2IDExLjQ3IDIyLjQ5IDEwLjcyIDIyLjM2IDEwSDEyVjE0LjI2SDE3LjkyQzE3LjY2IDE1LjYzIDE2Ljg2IDE2Ljc4IDE1LjY2IDE3LjUzVjIwLjM0SDE5LjI4QzIxLjM2IDE4LjQyIDIyLjU2IDE1LjYgMjIuNTYgMTIuMjVaIiBmaWxsPSIjNDI4NUY0Ii8+CjxwYXRoIGQ9Ik0xMiAyM0M5LjExIDIzIDYuNjYgMjEuOTIgNS4xIDIwLjM0TDEuNjUgMTcuNTNDNC42OSAyMC42MSA4LjEyIDIzIDEyIDIzWiIgZmlsbD0iIzM0QTg1MyIvPgo8cGF0aCBkPSJNNS4xIDIwLjM0QzQuMjUgMTkuNTIgMy41OCAxOC40MyAzLjIgMTcuMkgwVjIwLjM0QzAuNDggMjEuMDkgMS4wNCAyMS43NSAxLjY1IDIyLjI4TDUuMSAyMC4zNFoiIGZpbGw9IiNGQkJDMDQiLz4KPHA+" alt="Google" class="google-icon">
            <span>Continue with Google</span>
          </button>
          
          <div class="auth-switch">
            <p>Already have an account? <button type="button" onclick="switchToLogin()" class="switch-btn">Sign in</button></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cloud Sync Indicator -->
  <div id="cloudSyncIndicator" class="cloud-sync-indicator hidden">
    <span class="sync-icon">â˜ï¸</span>
    <span class="sync-text">Syncing...</span>
  </div>
  <!-- Map Container -->
  <div id="map-container">
    <div id="map"></div>
  </div>

  <!-- Compass -->
  <div id="compass">
    <div id="compass-needle"></div>
    <div id="compass-center"></div>
  </div>

  <!-- Top Control Bar -->
  <div class="top-bar">
    <button id="startBtn" class="round-button" title="Start Tracking">â–¶</button>
    <button id="pauseBtn" class="round-button" title="Pause">â¸</button>
    <button id="stopBtn" class="round-button" title="Stop">â¹</button>
    <span id="timer" class="stat-display">00:00:00</span>
    <span class="separator">|</span>
    <span id="distance" class="stat-display">0.00 km</span>
  </div>

  <!-- Left Controls -->
  <div class="floating-left">
    <button id="toggleBtn" class="round-button" title="Toggle Rotation">ğŸ§­</button>
    <button class="round-button" onclick="openAccessibilityForm()" title="Accessibility">â™¿</button>
  </div>

  <!-- Right Media Panel -->
  <div class="floating-right media-panel" id="mediaPanel">
    <button id="takePhotoBtn" class="round-button" title="Take Photo">ğŸ“·</button>
    <button class="round-button" onclick="addTextNote()" title="Add Note">ğŸ“</button>
    <button class="round-button" onclick="showRouteDataOnMap()" title="Show Route Data">ğŸ—º</button>
  </div>

  <!-- Bottom Navigation -->
  <div id="bottomNav" class="bottom-nav">
    <button class="nav-button" onclick="togglePanel('exportPanel')">Export</button>
    <button class="nav-button" onclick="togglePanel('summaryPanel')">Routes</button>
    <button class="nav-button" onclick="togglePanel('trailGuidePanel')">Guides</button>
    <button class="nav-button" onclick="togglePanel('devToolsPanel')">Tools</button>
  </div>

  <!-- Export Panel -->
  <div id="exportPanel" class="bottom-popup hidden">
    <button id="prepareAndExportBtn">ğŸ“¦ Export Route</button>
  <button id="exportGPXBtn">ğŸ“ Export GPX</button>
  <button id="exportPDFBtn">ğŸ“„ Export PDF</button>
  <button id="exportSummaryBtn">ğŸŒ Export Trail Guide</button>
  <button id="saveToCloudBtn" class="cloud-save-btn">â˜ï¸ Save to Cloud</button>
  </div>

  <!-- Summary Panel -->
  <div id="summaryPanel" class="bottom-popup hidden">
    <button id="loadCloudRoutesBtn" class="cloud-load-btn">â˜ï¸ Load My Routes</button>
  <button id="loadMyGuidesBtn" class="cloud-load-btn">ğŸŒ Load My Guides</button>
  <button id="clearAllSessionsBtn">ğŸ—‘ï¸ Clear Routes</button>
  <button id="clearAllAppDataBtn">ğŸ§¹ Clear Everything</button>
  </div>

  <!-- Dev Tools Panel -->
  <div id="devToolsPanel" class="bottom-popup hidden">
    <button onclick="showStorageMonitor()">ğŸ§ª Storage Monitor</button>
    <button onclick="triggerImport()">ğŸ“¥ Import Route</button>
    <button id="resetBtn" onclick="confirmAndResetApp()">ğŸ”„ Reset App</button>
  </div>

  <!-- Add this new panel after your existing panels -->
<!-- <div id="trailGuidePanel" class="bottom-popup hidden">
  <h3>ğŸŒ My Trail Guides</h3>
  <button id="loadMyGuidesBtn">ğŸ“‚ Load My Guides</button>
  <div id="myGuidesList" class="guides-list"> -->
    <!-- Dynamically populated -->
  <!-- </div>
</div> -->

  <!-- Accessibility Form Modal -->
  <div id="accessibilityOverlay" class="overlay hidden">
    <div id="accessibilityFormContainer" class="modal-container"></div>
  </div>

  <!-- Hidden File Inputs -->
  <input type="file" id="photoInput" accept="image/*" capture="environment" class="hidden">
  <input type="file" id="importFile" accept=".json,.gpx" class="hidden">

  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <!-- App JavaScript -->
  <script type="module" src="src/main.js"></script>
  <script type="module" src="src/features/auth.js"></script>

  <script type="module">
  import { auth } from './firebase-setup.js';
  import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js';
  
  // Hamburger menu toggle
  const menuToggle = document.getElementById('menuToggle');
  const navMenu = document.getElementById('navMenu');
  
  menuToggle?.addEventListener('click', () => {
    navMenu?.classList.toggle('active');
    menuToggle?.classList.toggle('active');
  });
  
  // Close menu when clicking a link
  navMenu?.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', () => {
      navMenu?.classList.remove('active');
      menuToggle?.classList.remove('active');
    });
  });
  
  // Auth state
  onAuthStateChanged(auth, (user) => {
    const indicator = document.getElementById('navAuthIndicator');
    const text = document.getElementById('navAuthStatusText');
    const btn = document.getElementById('navAuthBtn');
    
    if (user) {
      indicator?.classList.add('signed-in');
      if (text) text.textContent = user.displayName || user.email?.split('@')[0];
      if (btn) {
        btn.textContent = 'Sign Out';
        btn.onclick = () => {
          if (confirm('Sign out of Access Nature?')) {
            signOut(auth);
          }
        };
      }
    } else {
      indicator?.classList.remove('signed-in');
      if (text) text.textContent = 'Guest';
      if (btn) {
        btn.textContent = 'Sign In';
        btn.onclick = () => {
          // Open existing auth modal instead of Google popup
          const authModal = document.getElementById('authModal');
          if (authModal) {
            authModal.classList.remove('hidden');
          } else {
            // Fallback: try clicking the existing sign in button
            document.getElementById('showAuthBtn')?.click();
          }
        };
      }
    }
  });
</script>
</body>
</html>
