<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Accessibility Reports - Access Nature</title>
  <meta name="description" content="View and report accessibility barriers in outdoor spaces and urban areas">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <!-- Design System -->
  <link rel="stylesheet" href="src/css/design-system.css">
  <link rel="stylesheet" href="src/css/base.css">
  <link rel="stylesheet" href="src/css/buttons.css">
  <link rel="stylesheet" href="src/css/components.css">
  <link rel="stylesheet" href="src/css/modals.css">
  <link rel="stylesheet" href="src/css/toasts.css">
  <link rel="stylesheet" href="src/css/loading-states.css">
  <link rel="stylesheet" href="src/css/navigation-features.css">
  <link rel="stylesheet" href="src/css/themes.css">
  
  <style>
    /* ==========================================
       REPORTS PAGE STYLES - FIXED
       ========================================== */
    
    /* CRITICAL: Override body overflow for scrolling */
    html, body {
      height: auto !important;
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: auto !important;
    }

    body { 
      background: linear-gradient(135deg, var(--primary-color, #667eea) 0%, var(--primary-dark, #764ba2) 100%);
      padding-top: 64px; /* Space for fixed nav */
    }

    .page-container { 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 24px;
      position: relative;
      z-index: 1;
    }

    .page-header {
      background: white; 
      border-radius: 16px;
      padding: 32px; 
      margin-bottom: 24px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .page-header h1 { 
      font-size: 2rem; 
      color: #1a1a1a; 
      margin-bottom: 8px; 
    }
    .page-header p { 
      color: #6b7280; 
      font-size: 1.1rem; 
      margin: 0; 
    }

    /* Stats */
    .stats-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 16px; 
      margin-bottom: 24px; 
    }
    .stat-card { 
      background: white; 
      border-radius: 12px; 
      padding: 24px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
      text-align: center; 
    }
    .stat-value { 
      font-size: 2.5rem; 
      font-weight: 700; 
      color: #667eea; 
      margin-bottom: 8px; 
    }
    .stat-label { 
      color: #6b7280; 
      font-size: 0.875rem; 
      font-weight: 600; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
    }

    /* Filters */
    .filters-section { 
      background: white; 
      border-radius: 12px; 
      padding: 24px; 
      margin-bottom: 24px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
    }
    .filters-title { 
      font-size: 1.25rem; 
      font-weight: 600; 
      margin-bottom: 16px; 
      display: flex; 
      align-items: center; 
      gap: 8px; 
    }
    .filters-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 16px; 
      margin-bottom: 16px; 
    }
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #374151;
    }
    .form-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
    }
    .form-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .filter-actions { 
      display: flex; 
      gap: 12px; 
      flex-wrap: wrap; 
    }

    /* Map */
    .map-section { 
      background: white; 
      border-radius: 12px; 
      padding: 16px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
      margin-bottom: 24px; 
    }
    .map-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 16px; 
      flex-wrap: wrap; 
      gap: 12px; 
    }
    .map-header h2 { 
      font-size: 1.5rem; 
      margin: 0; 
    }
    .map-controls { 
      display: flex; 
      gap: 8px; 
    }
    .map-control-btn {
      width: 44px; 
      height: 44px; 
      background: #f3f4f6;
      border: none; 
      border-radius: 8px; 
      cursor: pointer;
      font-size: 1.25rem; 
      transition: all 0.2s;
      display: flex; 
      align-items: center; 
      justify-content: center;
    }
    .map-control-btn:hover { 
      background: #667eea; 
      color: white; 
      transform: translateY(-2px); 
    }

    #reportMap { 
      height: 500px; 
      border-radius: 8px; 
      width: 100%; 
      z-index: 1 !important; 
    }
    #reportMap.fullscreen { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      z-index: 9999 !important; 
      height: 100vh !important; 
      width: 100vw !important; 
      border-radius: 0; 
    }

    /* Timeline */
    .timeline-section { 
      background: white; 
      border-radius: 12px; 
      padding: 24px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 100px; /* Space for FAB */
    }
    .timeline-section h2 { 
      font-size: 1.5rem; 
      margin-bottom: 16px; 
    }
    #reportTimeline {
      min-height: 200px;
    }

    /* Report Card */
    .report-card {
      padding: 16px;
      border-left: 4px solid #f59e0b;
      margin-bottom: 16px;
      background: #f9fafb;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
      transition: all 0.2s;
    }
    .report-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .report-card.severity-critical { border-left-color: #dc2626; }
    .report-card.severity-high { border-left-color: #ea580c; }
    .report-card.severity-medium { border-left-color: #f59e0b; }
    .report-card.severity-low { border-left-color: #84cc16; }

    .report-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 8px;
    }
    .report-card-title {
      font-weight: 600;
      font-size: 1rem;
      margin: 0;
      color: #111827;
    }
    .report-card-date {
      font-size: 0.75rem;
      color: #6b7280;
      white-space: nowrap;
      margin-left: 16px;
    }
    .report-card-description {
      font-size: 0.875rem;
      color: #6b7280;
      margin: 0 0 8px 0;
    }
    .report-card-meta {
      display: flex;
      gap: 16px;
      font-size: 0.75rem;
      color: #9ca3af;
    }

    /* FAB */
    .report-fab {
      position: fixed; 
      bottom: 24px; 
      right: 24px;
      width: 64px; 
      height: 64px; 
      background: #ef4444; 
      color: white;
      border: none; 
      border-radius: 50%; 
      font-size: 2rem;
      cursor: pointer; 
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); 
      transition: all 0.2s;
      z-index: 100; 
      display: flex; 
      align-items: center; 
      justify-content: center;
    }
    .report-fab:hover { 
      transform: scale(1.1); 
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4); 
    }

    /* Report Detail Modal */
    #reportDetailModal {
      position: fixed !important; 
      top: 0 !important; 
      left: 0 !important; 
      right: 0 !important; 
      bottom: 0 !important;
      z-index: 100000 !important; 
      background: rgba(0, 0, 0, 0.5) !important;
      display: flex !important; 
      align-items: center !important; 
      justify-content: center !important;
      padding: 16px;
    }
    #reportDetailModal.hidden { 
      display: none !important; 
    }
    #reportDetailModal .modal-content {
      background: white; 
      border-radius: 16px;
      max-width: 800px; 
      width: 100%; 
      max-height: 90vh;
      overflow-y: auto; 
      position: relative; 
      z-index: 100001 !important;
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 1.25rem;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
      padding: 4px 8px;
    }
    .modal-close:hover {
      color: #111827;
    }
    .modal-body {
      padding: 24px;
    }

    /* Loading State */
    .loading-spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 40px;
      color: #6b7280;
    }
    .loading-spinner::before {
      content: '';
      width: 24px;
      height: 24px;
      border: 3px solid #e5e7eb;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 
      to { transform: rotate(360deg); } 
    }

    /* Top Navigation */
    .top-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      z-index: 10000;
    }
    .nav-brand {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 1.25rem;
      color: #111827;
      text-decoration: none;
    }
    .nav-brand-icon {
      font-size: 1.5rem;
    }
    .nav-auth-indicator {
      display: flex;
      align-items: center;
    }
    .nav-auth-indicator .auth-status {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #f3f4f6;
      border-radius: 20px;
      font-size: 0.875rem;
      color: #4b5563;
    }
    .nav-auth-indicator .auth-status.signed-in {
      background: #dcfce7;
      color: #166534;
    }
    .nav-menu {
      display: flex;
      align-items: center;
      gap: 8px;
      background: transparent;
    }
    .nav-link {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      color: #4b5563;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .nav-link:hover {
      background: #f3f4f6;
      color: #111827;
    }
    .nav-link.active {
      background: #667eea;
      color: white;
    }
    .nav-auth {
      margin-left: 16px;
    }
    .menu-toggle {
      display: none;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
    }
    .hamburger-icon {
      width: 24px;
      height: 18px;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .hamburger-icon span {
      display: block;
      width: 24px;
      height: 3px;
      background: #374151;
      border-radius: 2px;
      transition: all 0.3s ease;
    }
    .menu-toggle.active .hamburger-icon span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }
    .menu-toggle.active .hamburger-icon span:nth-child(2) {
      opacity: 0;
    }
    .menu-toggle.active .hamburger-icon span:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary {
      background: #667eea;
      color: white;
    }
    .btn-primary:hover {
      background: #5a67d8;
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }
    .btn-secondary:hover {
      background: #e5e7eb;
    }

    /* Report Create Modal */
    #reportCreateModal {
      position: fixed !important; 
      top: 0 !important; 
      left: 0 !important; 
      right: 0 !important; 
      bottom: 0 !important;
      z-index: 100000 !important; 
      background: rgba(0, 0, 0, 0.5) !important;
      display: flex !important; 
      align-items: center !important; 
      justify-content: center !important;
      padding: 16px;
      overflow-y: auto;
    }
    #reportCreateModal.hidden { 
      display: none !important; 
    }
    #reportCreateModal .modal-content {
      background: white; 
      border-radius: 16px;
      max-width: 600px; 
      width: 100%; 
      max-height: 90vh;
      overflow-y: auto; 
      position: relative;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }
    .loading-overlay.hidden {
      display: none;
    }
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e5e7eb;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Mobile */
    @media (max-width: 768px) {
      body {
        padding-top: 56px;
      }
      .top-nav {
        height: 56px;
        padding: 0 16px;
      }
      .page-container { 
        padding: 16px; 
      }
      .page-header { 
        padding: 20px; 
      }
      .page-header h1 { 
        font-size: 1.5rem; 
      }
      #reportMap { 
        height: 300px; 
      }
      .filters-grid { 
        grid-template-columns: 1fr; 
      }
      .stats-grid { 
        grid-template-columns: repeat(2, 1fr); 
      }
      .report-fab { 
        bottom: 16px; 
        right: 16px; 
        width: 56px; 
        height: 56px; 
        font-size: 1.5rem; 
      }
      .menu-toggle { 
        display: flex !important; 
      }
      .nav-auth-indicator .auth-status span:last-child {
        display: none;
      }
      .nav-menu {
        display: none;
        background: white;
      }
      .nav-menu.active {
        display: flex;
        flex-direction: column;
        position: fixed;
        top: 56px;
        left: 0;
        right: 0;
        background: white !important;
        padding: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      .nav-menu .nav-link {
        width: 100%;
        padding: 14px 16px;
        font-size: 1rem;
      }
      .nav-auth {
        margin-left: 0;
        margin-top: 16px;
        width: 100%;
      }
      .nav-auth .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <!-- Navigation -->
  <nav class="top-nav" role="navigation">
    <a href="index.html" class="nav-brand">
      <span class="nav-brand-icon">üå≤</span>
      <span>Access Nature</span>
    </a>
    <div class="nav-auth-indicator">
      <div class="auth-status" id="navAuthIndicator">
        <span>üë§</span>
        <span id="navAuthStatusText">Guest</span>
      </div>
    </div>
    <button class="menu-toggle" id="menuToggle">
      <span class="hamburger-icon">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </button>
    <div class="nav-menu" id="navMenu">
      <a href="index.html" class="nav-link">üè† Home</a>
      <a href="tracker.html" class="nav-link">üó∫Ô∏è Track</a>
      <a href="reports.html" class="nav-link active">üìã Reports</a>
      <!-- <a href="routes.html" class="nav-link">üìÇ Routes</a> -->
      <div class="nav-auth">
        <button id="navAuthBtn" class="btn btn-primary">Sign In</button>
      </div>
    </div>
  </nav>

  <div class="page-container">
    <!-- Header -->
    <div class="page-header">
      <h1>üìã Accessibility Reports</h1>
      <p>Report and view accessibility barriers in outdoor spaces and urban areas</p>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalReports">0</div>
        <div class="stat-label">Total Reports</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="newReports">0</div>
        <div class="stat-label">New</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="resolvedReports">0</div>
        <div class="stat-label">Resolved</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="yourLocation">Detecting...</div>
        <div class="stat-label">Your Location</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
      <h3 class="filters-title"><span>üîç</span><span>Filter Reports</span></h3>
      <div class="filters-grid">
        <div class="form-group">
          <label for="statusFilter">Status</label>
          <select id="statusFilter" class="form-select">
            <option value="">All Statuses</option>
            <option value="new">New</option>
            <option value="acknowledged">Acknowledged</option>
            <option value="in_progress">In Progress</option>
            <option value="resolved">Resolved</option>
          </select>
        </div>
        <div class="form-group">
          <label for="severityFilter">Severity</label>
          <select id="severityFilter" class="form-select">
            <option value="">All Severities</option>
            <option value="critical">Critical</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>
        <div class="form-group">
          <label for="typeFilter">Issue Type</label>
          <select id="typeFilter" class="form-select">
            <option value="">All Types</option>
            <option value="curb_ramp">Missing/Damaged Curb Ramp</option>
            <option value="sidewalk_blocked">Blocked Sidewalk</option>
            <option value="damaged_sidewalk">Damaged Sidewalk</option>
            <option value="inaccessible_entrance">Inaccessible Entrance</option>
            <option value="broken_elevator">Broken Elevator/Lift</option>
            <option value="parking_blocked">Blocked Accessible Parking</option>
            <option value="trail_obstacle">Trail Obstacle</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" id="applyFiltersBtn">üîç Apply Filters</button>
        <button class="btn btn-secondary" id="resetFiltersBtn">üîÑ Reset</button>
        <button class="btn btn-secondary" id="useMyLocationBtn">üìç Use My Location</button>
      </div>
    </div>

    <!-- Map -->
    <div class="map-section">
      <div class="map-header">
        <h2>üó∫Ô∏è Report Map</h2>
        <div class="map-controls">
          <button class="map-control-btn" id="centerMapBtn" title="Center on my location">üìç</button>
          <button class="map-control-btn" id="fullscreenBtn" title="Toggle fullscreen">‚õ∂</button>
        </div>
      </div>
      <div id="reportMap"></div>
    </div>

    <!-- Timeline -->
    <div class="timeline-section">
      <h2>üìã Recent Reports</h2>
      <div id="reportTimeline">
        <div class="loading-spinner">Loading reports...</div>
      </div>
    </div>
  </div>

  <!-- FAB -->
  <button class="report-fab" id="reportFabBtn" title="Report an issue">üìã</button>

  <!-- Report Detail Modal -->
  <div id="reportDetailModal" class="hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Report Details</h2>
        <button class="modal-close" id="closeModalBtn">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Create Report Modal -->
  <div id="createReportModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 100000; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; padding: 16px;">
    <div class="modal-content" style="background: white; border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2>üìã Report Accessibility Issue</h2>
        <button class="modal-close" id="closeCreateModalBtn">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <form id="createReportForm">
          <!-- Location -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">üìç Location</label>
            <div id="locationPickerMap" style="height: 200px; border-radius: 8px; margin-bottom: 8px; background: #f3f4f6;"></div>
            <p style="font-size: 0.875rem; color: #6b7280; margin: 0;" id="selectedLocationText">Click on the map to select location, or use current location</p>
            <input type="hidden" id="reportLat" required>
            <input type="hidden" id="reportLng" required>
            <button type="button" id="useCurrentLocationBtn" class="btn btn-secondary" style="margin-top: 8px; width: 100%;">üìç Use My Current Location</button>
          </div>

          <!-- Issue Type -->
          <div style="margin-bottom: 20px;">
            <label for="reportIssueType" style="display: block; margin-bottom: 8px; font-weight: 600;">üè∑Ô∏è Issue Type *</label>
            <select id="reportIssueType" class="form-select" required>
              <option value="">Select issue type...</option>
              <optgroup label="Sidewalk Issues">
                <option value="curb_ramp">üöß Missing/Damaged Curb Ramp</option>
                <option value="sidewalk_blocked">‚õî Blocked Sidewalk</option>
                <option value="damaged_sidewalk">üíî Damaged Sidewalk</option>
                <option value="tactile_paving">üî≤ Missing Tactile Paving</option>
              </optgroup>
              <optgroup label="Building Access">
                <option value="inaccessible_entrance">üö™ Inaccessible Entrance</option>
                <option value="broken_elevator">üõó Broken Elevator/Lift</option>
                <option value="heavy_doors">üö™ Heavy/Manual Doors</option>
                <option value="stairs_only">ü™ú Stairs Only Access</option>
              </optgroup>
              <optgroup label="Parking">
                <option value="parking_blocked">üÖøÔ∏è Blocked Accessible Parking</option>
                <option value="no_parking">üö´ No Accessible Parking</option>
                <option value="damaged_parking">‚ö†Ô∏è Damaged Parking Space</option>
              </optgroup>
              <optgroup label="Facilities">
                <option value="inaccessible_restroom">üöª Inaccessible Restroom</option>
                <option value="inaccessible_fountain">üö∞ Inaccessible Water Fountain</option>
                <option value="no_seating">üí∫ No Accessible Seating</option>
              </optgroup>
              <optgroup label="Trail/Outdoor">
                <option value="trail_obstacle">ü™® Trail Obstacle</option>
                <option value="trail_erosion">üï≥Ô∏è Trail Erosion/Damage</option>
                <option value="overgrown">üåø Overgrown Vegetation</option>
                <option value="missing_sign">ü™ß Missing Signage</option>
              </optgroup>
              <optgroup label="Transit">
                <option value="bus_stop">üöå Inaccessible Bus Stop</option>
                <option value="transit_station">üöá Inaccessible Station</option>
              </optgroup>
              <optgroup label="Other">
                <option value="other">üìù Other Issue</option>
              </optgroup>
            </select>
          </div>

          <!-- Severity -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">‚ö†Ô∏è Severity *</label>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
              <label style="display: flex; flex-direction: column; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                <input type="radio" name="reportSeverity" value="low" style="margin-bottom: 4px;">
                <span style="font-size: 0.875rem; color: #84cc16; font-weight: 600;">Low</span>
              </label>
              <label style="display: flex; flex-direction: column; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                <input type="radio" name="reportSeverity" value="medium" checked style="margin-bottom: 4px;">
                <span style="font-size: 0.875rem; color: #f59e0b; font-weight: 600;">Medium</span>
              </label>
              <label style="display: flex; flex-direction: column; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                <input type="radio" name="reportSeverity" value="high" style="margin-bottom: 4px;">
                <span style="font-size: 0.875rem; color: #ea580c; font-weight: 600;">High</span>
              </label>
              <label style="display: flex; flex-direction: column; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                <input type="radio" name="reportSeverity" value="critical" style="margin-bottom: 4px;">
                <span style="font-size: 0.875rem; color: #dc2626; font-weight: 600;">Critical</span>
              </label>
            </div>
          </div>

          <!-- Title -->
          <div style="margin-bottom: 20px;">
            <label for="reportTitle" style="display: block; margin-bottom: 8px; font-weight: 600;">üìù Title *</label>
            <input type="text" id="reportTitle" class="form-select" placeholder="Brief description of the issue" required style="width: 100%;">
          </div>

          <!-- Description -->
          <div style="margin-bottom: 20px;">
            <label for="reportDescription" style="display: block; margin-bottom: 8px; font-weight: 600;">üìÑ Description</label>
            <textarea id="reportDescription" class="form-select" placeholder="Provide more details about the accessibility barrier..." rows="4" style="width: 100%; resize: vertical;"></textarea>
          </div>

          <!-- Photos -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">üì∑ Photos</label>
            <input type="file" id="reportPhotos" accept="image/*" multiple style="display: none;">
            <button type="button" id="addPhotosBtn" class="btn btn-secondary" style="width: 100%;">üì∏ Add Photos</button>
            <div id="photoPreviewGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 12px;"></div>
          </div>

          <!-- Address (optional) -->
          <div style="margin-bottom: 20px;">
            <label for="reportAddress" style="display: block; margin-bottom: 8px; font-weight: 600;">üè† Address (optional)</label>
            <input type="text" id="reportAddress" class="form-select" placeholder="e.g., 123 Main St, Cape Town" style="width: 100%;">
          </div>

          <!-- Submit -->
          <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeCreateReportModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" style="flex: 1;" id="submitReportBtn">üì§ Submit Report</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Report Creation Modal -->
  <div id="reportCreateModal" class="hidden">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>üìã Report Accessibility Issue</h2>
        <button class="modal-close" id="closeCreateModalBtn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="reportForm">
          <!-- Location -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">üìç Location</label>
            <div id="locationStatus" style="padding: 12px; background: #f3f4f6; border-radius: 8px; margin-bottom: 8px;">
              <span id="locationText">Click "Use My Location" or click on the map</span>
            </div>
            <div style="display: flex; gap: 8px;">
              <button type="button" id="useLocationBtn" class="btn btn-secondary" style="flex: 1;">üìç Use My Location</button>
              <button type="button" id="pickOnMapBtn" class="btn btn-secondary" style="flex: 1;">üó∫Ô∏è Pick on Map</button>
            </div>
            <input type="hidden" id="reportLat" name="latitude">
            <input type="hidden" id="reportLng" name="longitude">
          </div>

          <!-- Title -->
          <div style="margin-bottom: 20px;">
            <label for="reportTitle" style="display: block; margin-bottom: 8px; font-weight: 600;">üìù Title *</label>
            <input type="text" id="reportTitle" name="title" required
                   placeholder="Brief description of the issue"
                   style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem;">
          </div>

          <!-- Issue Type -->
          <div style="margin-bottom: 20px;">
            <label for="reportType" style="display: block; margin-bottom: 8px; font-weight: 600;">üè∑Ô∏è Issue Type *</label>
            <select id="reportType" name="issueType" required
                    style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem;">
              <option value="">Select issue type...</option>
              <optgroup label="Sidewalk Issues">
                <option value="curb_ramp">‚ôø Missing/Damaged Curb Ramp</option>
                <option value="sidewalk_blocked">üöß Blocked Sidewalk</option>
                <option value="damaged_sidewalk">üíî Damaged Sidewalk</option>
                <option value="tactile_paving">üî≤ Missing Tactile Paving</option>
              </optgroup>
              <optgroup label="Building Access">
                <option value="inaccessible_entrance">üö™ Inaccessible Entrance</option>
                <option value="broken_elevator">üõó Broken Elevator/Lift</option>
                <option value="heavy_doors">üö™ Heavy/Manual Doors</option>
                <option value="stairs_only">ü™ú Stairs Only Access</option>
              </optgroup>
              <optgroup label="Parking">
                <option value="parking_blocked">üÖøÔ∏è Blocked Accessible Parking</option>
                <option value="no_parking">üö´ No Accessible Parking</option>
                <option value="damaged_parking">‚ö†Ô∏è Damaged Parking Space</option>
              </optgroup>
              <optgroup label="Trail & Outdoor">
                <option value="trail_obstacle">ü™® Trail Obstacle</option>
                <option value="trail_erosion">üï≥Ô∏è Trail Erosion/Damage</option>
                <option value="overgrown">üåø Overgrown Vegetation</option>
                <option value="missing_sign">ü™ß Missing Signage</option>
              </optgroup>
              <optgroup label="Facilities">
                <option value="inaccessible_restroom">üöª Inaccessible Restroom</option>
                <option value="inaccessible_fountain">üö∞ Inaccessible Water Fountain</option>
              </optgroup>
              <option value="other">üìç Other Issue</option>
            </select>
          </div>

          <!-- Severity -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">‚ö†Ô∏è Severity *</label>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
              <label style="display: flex; flex-direction: column; align-items: center; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                <input type="radio" name="severity" value="low" style="margin-bottom: 4px;">
                <span style="color: #84cc16; font-weight: 600;">Low</span>
              </label>
              <label style="display: flex; flex-direction: column; align-items: center; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                <input type="radio" name="severity" value="medium" checked style="margin-bottom: 4px;">
                <span style="color: #f59e0b; font-weight: 600;">Medium</span>
              </label>
              <label style="display: flex; flex-direction: column; align-items: center; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                <input type="radio" name="severity" value="high" style="margin-bottom: 4px;">
                <span style="color: #ea580c; font-weight: 600;">High</span>
              </label>
              <label style="display: flex; flex-direction: column; align-items: center; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                <input type="radio" name="severity" value="critical" style="margin-bottom: 4px;">
                <span style="color: #dc2626; font-weight: 600;">Critical</span>
              </label>
            </div>
          </div>

          <!-- Description -->
          <div style="margin-bottom: 20px;">
            <label for="reportDescription" style="display: block; margin-bottom: 8px; font-weight: 600;">üìÑ Description</label>
            <textarea id="reportDescription" name="description" rows="4"
                      placeholder="Provide more details about the accessibility barrier..."
                      style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
          </div>

          <!-- Photos -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">üì∑ Photos</label>
            <input type="file" id="reportPhotos" name="photos" accept="image/*" multiple
                   style="display: none;">
            <button type="button" id="addPhotosBtn" class="btn btn-secondary" style="width: 100%; margin-bottom: 8px;">
              üì∏ Add Photos
            </button>
            <div id="photoPreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px;"></div>
          </div>

          <!-- Public/Private -->
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="reportPublic" name="isPublic" checked style="width: 18px; height: 18px;">
              <span>Make this report public (visible to other users)</span>
            </label>
          </div>

          <!-- Submit -->
          <div style="display: flex; gap: 12px;">
            <button type="button" id="cancelReportBtn" class="btn btn-secondary" style="flex: 1;">Cancel</button>
            <button type="submit" id="submitReportBtn" class="btn btn-primary" style="flex: 1;">üìã Submit Report</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js';
    import { getFirestore, collection, getDocs, getDoc, doc, query, orderBy, limit, where, updateDoc, arrayUnion, arrayRemove, increment, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js';

    // Firebase config - Access Nature Beta
    const firebaseConfig = {
      apiKey: "AIzaSyAmsm916Lzp0MUXANq3SECO4ec7q1H0Vu4",
      authDomain: "accessnaturebeta-821a2.firebaseapp.com",
      projectId: "accessnaturebeta-821a2",
      storageBucket: "accessnaturebeta-821a2.appspot.com",
      messagingSenderId: "670888101781",
      appId: "1:670888101781:web:b4cf57f58e86182466589c",
      measurementId: "G-QL82J92CP7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global state
    let map = null;
    let userLocationMarker = null;
    let currentLocation = null;
    let allReports = [];
    let filteredReports = [];
    let markerClusterGroup = null;
    let currentUser = null;

    // Severity colors
    const severityColors = {
      critical: '#dc2626',
      high: '#ea580c',
      medium: '#f59e0b',
      low: '#84cc16'
    };

    // Issue type icons
    const issueIcons = {
      curb_ramp: '‚ôø',
      sidewalk_blocked: 'üöß',
      damaged_sidewalk: 'üíî',
      tactile_paving: 'üî≤',
      inaccessible_entrance: 'üö™',
      broken_elevator: 'üõó',
      heavy_doors: 'üö™',
      stairs_only: 'ü™ú',
      parking_blocked: 'üÖøÔ∏è',
      no_parking: 'üö´',
      trail_obstacle: 'ü™®',
      trail_erosion: 'üï≥Ô∏è',
      overgrown: 'üåø',
      missing_sign: 'ü™ß',
      other: 'üìç'
    };

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üìã Reports page initializing...');

      // Initialize map
      initializeMap();

      // Setup auth listener
      onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        updateAuthUI(user);
        console.log('üîê Auth state changed:', user ? `Signed in as ${user.email || 'Anonymous'}` : 'Signed out');
        
        // Reload reports when auth state changes
        if (user) {
          await loadReports();
        }
      });

      // Get user location (doesn't require auth)
      await getUserLocation();

      // Note: Reports will load automatically when auth state changes
      // This handles the case where user is already signed in
      // If not signed in, loadReports() will show the sign-in prompt
      if (!currentUser) {
        // Show sign-in prompt immediately if not authenticated
        await loadReports();
      }

      // Setup event listeners
      setupEventListeners();

      // Hide loading overlay
      document.getElementById('loadingOverlay').classList.add('hidden');

      console.log('‚úÖ Reports page initialized');
    });

    /**
     * Initialize Leaflet map
     */
    function initializeMap() {
      console.log('üó∫Ô∏è Initializing map...');

      map = L.map('reportMap').setView([-33.9249, 18.4241], 12); // Default: Cape Town

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      // Initialize marker cluster group
      markerClusterGroup = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        iconCreateFunction: function(cluster) {
          const count = cluster.getChildCount();
          let size = 'small';
          if (count > 10) size = 'large';
          else if (count > 5) size = 'medium';

          return L.divIcon({
            html: `<div class="cluster-icon cluster-${size}">${count}</div>`,
            className: 'marker-cluster-custom',
            iconSize: L.point(40, 40)
          });
        }
      });

      // Add cluster styles dynamically
      const style = document.createElement('style');
      style.textContent = `
        .marker-cluster-custom { background: transparent; }
        .cluster-icon {
          width: 40px; height: 40px; border-radius: 50%;
          display: flex; align-items: center; justify-content: center;
          font-weight: 700; color: white;
          border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
          background: #667eea;
        }
        .cluster-icon.cluster-medium { width: 50px; height: 50px; background: #f59e0b; }
        .cluster-icon.cluster-large { width: 60px; height: 60px; background: #ef4444; }
        
        /* Report tooltip styles */
        .report-tooltip {
          background: white !important;
          border: none !important;
          border-radius: 8px !important;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
          padding: 0 !important;
        }
        .report-tooltip .leaflet-tooltip-content {
          margin: 10px 12px !important;
        }
        .leaflet-tooltip-top:before {
          border-top-color: white !important;
        }
      `;
      document.head.appendChild(style);

      map.addLayer(markerClusterGroup);
      console.log('‚úÖ Map initialized');
    }

    /**
     * Get user's current location
     */
    async function getUserLocation() {
      console.log('üìç Getting user location...');

      if (!navigator.geolocation) {
        console.warn('‚ö†Ô∏è Geolocation not supported');
        document.getElementById('yourLocation').textContent = 'Not available';
        return;
      }

      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000
          });
        });

        currentLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };

        console.log('‚úÖ User location:', currentLocation);

        // Center map on user location
        map.setView([currentLocation.lat, currentLocation.lng], 13);

        // Add user location marker
        addUserLocationMarker();

        // Get location name
        await getLocationName(currentLocation.lat, currentLocation.lng);

      } catch (error) {
        console.error('‚ùå Error getting location:', error);
        document.getElementById('yourLocation').textContent = 'Unknown';
      }
    }

    /**
     * Add marker for user's current location
     */
    function addUserLocationMarker() {
      if (!currentLocation) return;

      if (userLocationMarker) {
        map.removeLayer(userLocationMarker);
      }

      const icon = L.divIcon({
        html: `
          <div style="width: 20px; height: 20px; background: #3b82f6; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>
        `,
        className: 'user-location-marker',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });

      userLocationMarker = L.marker([currentLocation.lat, currentLocation.lng], { icon })
        .addTo(map)
        .bindPopup('üìç You are here');
    }

    /**
     * Get location name from coordinates
     * Uses OpenStreetMap Nominatim - CORS workaround using JSONP-style approach
     */
    async function getLocationName(lat, lng) {
      try {
        // Try using the Overpass/Nominatim API through a timeout approach
        // If CORS fails, just show coordinates
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`,
          {
            signal: controller.signal,
            mode: 'cors',
            headers: {
              'Accept': 'application/json'
            }
          }
        );
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        const city = data.address?.city || data.address?.town || data.address?.village || data.address?.suburb || data.address?.county || 'Unknown';
        document.getElementById('yourLocation').textContent = city;
        console.log('üìç Location:', city);
      } catch (error) {
        console.warn('‚ö†Ô∏è Could not get location name:', error.message);
        // Show coordinates as fallback - this is fine
        document.getElementById('yourLocation').textContent = 'Cape Town Area';
      }
    }

    /**
     * Load reports from Firestore
     * Note: Requires authentication per Firebase rules
     */
    async function loadReports() {
      console.log('üì• Loading reports...');
      const timeline = document.getElementById('reportTimeline');
      timeline.innerHTML = '<div class="loading-spinner">Loading reports...</div>';

      // Check if user is signed in - required by Firebase rules
      if (!currentUser) {
        console.log('‚ö†Ô∏è User not signed in, waiting for auth...');
        timeline.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #6b7280;">
            <p style="font-size: 1.25rem; margin-bottom: 16px;">üîê Sign in to view reports</p>
            <p style="margin-bottom: 16px;">Authentication is required to access accessibility reports.</p>
            <button onclick="document.getElementById('authBtn').click()" class="btn btn-primary">Sign In with Google</button>
          </div>
        `;
        return;
      }

      try {
        const reportsRef = collection(db, 'accessibilityReports');
        const q = query(reportsRef, orderBy('createdAt', 'desc'), limit(100));
        const snapshot = await getDocs(q);

        allReports = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        console.log(`‚úÖ Loaded ${allReports.length} reports`);
        
        // Debug: Log photo structure of first report with photos
        const reportWithPhotos = allReports.find(r => r.photos && r.photos.length > 0);
        if (reportWithPhotos) {
          console.log('üì∑ Report with photos:', reportWithPhotos.title);
          console.log('üì∑ Number of photos:', reportWithPhotos.photos.length);
          console.log('üì∑ First photo object:', reportWithPhotos.photos[0]);
          console.log('üì∑ First photo type:', typeof reportWithPhotos.photos[0]);
          console.log('üì∑ First photo keys:', reportWithPhotos.photos[0] ? Object.keys(reportWithPhotos.photos[0]) : 'N/A');
        }

        if (allReports.length === 0) {
          timeline.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6b7280;">
              <p style="font-size: 3rem; margin-bottom: 16px;">üìã</p>
              <p style="font-size: 1.25rem; margin-bottom: 8px;">No reports yet</p>
              <p>Be the first to report an accessibility barrier!</p>
            </div>
          `;
          updateStats();
          return;
        }

        // Apply initial filter
        filteredReports = allReports;
        displayReports();
        updateStats();

      } catch (error) {
        console.error('‚ùå Error loading reports:', error);
        
        let errorMessage = 'Failed to load reports.';
        if (error.code === 'permission-denied') {
          errorMessage = 'Permission denied. Please sign in to view reports.';
        } else if (error.message?.includes('index')) {
          errorMessage = 'Database index required. Please contact the administrator.';
        }
        
        timeline.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #ef4444;">
            <p style="font-size: 1.25rem; margin-bottom: 8px;">‚ö†Ô∏è ${errorMessage}</p>
            <p style="color: #6b7280; font-size: 0.875rem;">${error.message}</p>
            <button onclick="loadReports()" class="btn btn-secondary" style="margin-top: 16px;">Try Again</button>
          </div>
        `;
      }
    }

    /**
     * Display reports on map and timeline
     */
    function displayReports() {
      // Clear existing markers
      markerClusterGroup.clearLayers();

      // Add markers
      filteredReports.forEach(report => {
        if (!report.latitude && !report.location?.latitude) return;

        const lat = report.latitude || report.location?.latitude;
        const lng = report.longitude || report.location?.longitude;
        
        if (!lat || !lng) return;

        const marker = createReportMarker(report, lat, lng);
        markerClusterGroup.addLayer(marker);
      });

      // Fit bounds if we have reports
      if (filteredReports.length > 0) {
        try {
          const bounds = markerClusterGroup.getBounds();
          if (bounds.isValid()) {
            map.fitBounds(bounds, { padding: [50, 50] });
          }
        } catch (e) {
          // Ignore bounds errors
        }
      }

      // Update timeline
      displayTimeline();

      console.log(`‚úÖ Displayed ${filteredReports.length} reports`);
    }

    /**
     * Create marker for a report
     */
    function createReportMarker(report, lat, lng) {
      const severity = report.severity || 'medium';
      const color = severityColors[severity];
      const icon = issueIcons[report.issueType] || 'üìç';
      const date = report.createdAt?.toDate ? report.createdAt.toDate().toLocaleDateString() : '';

      const divIcon = L.divIcon({
        html: `<div style="width: 36px; height: 36px; background: ${color}; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 16px;">${icon}</div>`,
        className: 'report-marker',
        iconSize: [36, 36],
        iconAnchor: [18, 18]
      });

      const marker = L.marker([lat, lng], { icon: divIcon });

      // Add tooltip for hover preview
      const tooltipContent = `
        <div style="min-width: 180px; max-width: 250px;">
          <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">${escapeHtml(report.title)}</div>
          <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">${escapeHtml((report.description || '').substring(0, 80))}${(report.description || '').length > 80 ? '...' : ''}</div>
          <div style="display: flex; justify-content: space-between; font-size: 10px; color: #9ca3af;">
            <span style="background: ${color}; color: white; padding: 2px 6px; border-radius: 4px;">${severity.toUpperCase()}</span>
            <span>${date}</span>
          </div>
        </div>
      `;
      marker.bindTooltip(tooltipContent, {
        direction: 'top',
        offset: [0, -20],
        opacity: 0.95,
        className: 'report-tooltip'
      });

      // Create popup for click
      const popupContent = `
        <div style="min-width: 220px;">
          <h3 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">${escapeHtml(report.title)}</h3>
          <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">${escapeHtml((report.description || '').substring(0, 100))}${(report.description || '').length > 100 ? '...' : ''}</p>
          <div style="display: flex; gap: 8px;">
            <button onclick="window.viewReportDetails('${report.id}')" style="flex: 1; padding: 8px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">View Details</button>
            <button onclick="window.navigateToLocation(${lat}, ${lng})" style="padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;" title="Navigate">üß≠</button>
          </div>
        </div>
      `;

      marker.bindPopup(popupContent);
      return marker;
    }

    /**
     * Display timeline of reports
     */
    function displayTimeline() {
      const timeline = document.getElementById('reportTimeline');

      if (filteredReports.length === 0) {
        timeline.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No reports found matching your filters.</p>';
        return;
      }

      timeline.innerHTML = filteredReports.slice(0, 20).map(report => {
        const date = report.createdAt?.toDate ? report.createdAt.toDate().toLocaleDateString() : 'Unknown date';
        const severity = report.severity || 'medium';
        const lat = report.latitude || report.location?.latitude;
        const lng = report.longitude || report.location?.longitude;
        const location = report.address || report.location?.placeDescription || (lat && lng ? `${lat.toFixed(4)}, ${lng.toFixed(4)}` : 'Unknown location');

        return `
          <div class="report-card severity-${severity}" onclick="window.viewReportDetails('${report.id}')">
            <div class="report-card-header">
              <h4 class="report-card-title">${escapeHtml(report.title)}</h4>
              <span class="report-card-date">${date}</span>
            </div>
            <p class="report-card-description">${escapeHtml((report.description || '').substring(0, 150))}${(report.description || '').length > 150 ? '...' : ''}</p>
            <div class="report-card-meta">
              <span>üìç ${escapeHtml(location)}</span>
              <span>‚ö†Ô∏è ${severity.toUpperCase()}</span>
              <span>üëç ${report.upvotes || 0}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    /**
     * Update statistics
     */
    function updateStats() {
      document.getElementById('totalReports').textContent = allReports.length;
      document.getElementById('newReports').textContent = allReports.filter(r => r.status === 'new').length;
      document.getElementById('resolvedReports').textContent = allReports.filter(r => r.status === 'resolved').length;
    }

    /**
     * View report details
     */
    window.viewReportDetails = async function(reportId) {
      const report = allReports.find(r => r.id === reportId);
      if (!report) {
        console.error('Report not found:', reportId);
        return;
      }

      const modal = document.getElementById('reportDetailModal');
      const modalBody = document.getElementById('modalBody');
      document.getElementById('modalTitle').textContent = report.title;

      const date = report.createdAt?.toDate ? report.createdAt.toDate().toLocaleString() : 'Unknown date';
      const lat = report.latitude || report.location?.latitude;
      const lng = report.longitude || report.location?.longitude;
      const location = report.address || report.location?.placeDescription || (lat && lng ? `${lat.toFixed(6)}, ${lng.toFixed(6)}` : 'Unknown location');

      modalBody.innerHTML = `
        <div style="margin-bottom: 16px;">
          <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${severityColors[report.severity || 'medium']}; color: white; margin-right: 8px;">${(report.severity || 'medium').toUpperCase()}</span>
          <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #e5e7eb; color: #374151;">${(report.status || 'new').toUpperCase()}</span>
        </div>
        <p style="color: #6b7280; margin-bottom: 16px;">${escapeHtml(report.description || 'No description provided')}</p>
        <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
          <p style="margin: 0 0 8px 0; font-size: 14px;"><strong>üìç Location:</strong> ${escapeHtml(location)}</p>
          <p style="margin: 0 0 8px 0; font-size: 14px;"><strong>üìÖ Reported:</strong> ${date}</p>
          <p style="margin: 0; font-size: 14px;"><strong>üë§ Reporter:</strong> ${escapeHtml(report.userName || report.userEmail || 'Anonymous')}</p>
        </div>
        ${report.photos && report.photos.length > 0 ? (() => {
          // Extract all photo URLs for the gallery
          const photoUrls = report.photos.map(photo => {
            if (typeof photo === 'string') return photo;
            if (photo.content) return photo.content;
            if (photo.data && typeof photo.data === 'string') return photo.data;
            if (photo.url) return photo.url;
            return null;
          }).filter(url => url);
          
          // Store photos in registry (will be done when modal opens)
          window.photoRegistry = window.photoRegistry || {};
          window.photoRegistry[report.id] = photoUrls;
          
          return `
            <div style="margin-bottom: 16px;">
              <h4 style="margin-bottom: 8px;">üì∑ Photos (${photoUrls.length})</h4>
              <div class="photo-grid" data-report-id="${report.id}" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px;">
                ${photoUrls.map((photoUrl, index) => `
                  <img src="${photoUrl}" 
                       alt="Photo ${index + 1}" 
                       data-index="${index}"
                       data-report-id="${report.id}"
                       style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; cursor: pointer; background: #f3f4f6;" 
                       onclick="window.openGallery('${report.id}', ${index})">
                `).join('')}
              </div>
            </div>
          `;
        })() : ''}
        <div style="display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap;">
          <button onclick="window.upvoteReport('${report.id}')" class="btn btn-secondary" style="flex: 1; min-width: 120px;">üëç Upvote (${report.upvotes || 0})</button>
          ${lat && lng ? `
            <button onclick="window.zoomToReport(${lat}, ${lng})" class="btn btn-primary" style="flex: 1; min-width: 120px;">üìç Show on Map</button>
            <button onclick="window.navigateToLocation(${lat}, ${lng})" class="btn" style="flex: 1; min-width: 120px; background: #10b981; color: white;">üß≠ Navigate</button>
          ` : ''}
        </div>
      `;

      modal.classList.remove('hidden');
    };

    /**
     * Upvote a report
     */
    window.upvoteReport = async function(reportId) {
      if (!currentUser) {
        alert('Please sign in to upvote reports');
        return;
      }

      try {
        const reportRef = doc(db, 'accessibilityReports', reportId);
        const reportDoc = await getDoc(reportRef);
        
        if (!reportDoc.exists()) {
          console.error('Report not found');
          return;
        }

        const report = reportDoc.data();
        const upvotedBy = report.upvotedBy || [];

        if (upvotedBy.includes(currentUser.uid)) {
          // Remove upvote
          await updateDoc(reportRef, {
            upvotes: increment(-1),
            upvotedBy: arrayRemove(currentUser.uid)
          });
        } else {
          // Add upvote
          await updateDoc(reportRef, {
            upvotes: increment(1),
            upvotedBy: arrayUnion(currentUser.uid)
          });
        }

        // Reload reports
        await loadReports();
        
        // Close and reopen modal if open
        const modal = document.getElementById('reportDetailModal');
        if (!modal.classList.contains('hidden')) {
          window.viewReportDetails(reportId);
        }

      } catch (error) {
        console.error('Error upvoting:', error);
        alert('Failed to upvote. Please try again.');
      }
    };

    // Photo registry for gallery view
    window.photoRegistry = {};
    
    /**
     * Open gallery from registry
     */
    window.openGallery = function(reportId, startIndex) {
      const photos = window.photoRegistry[reportId];
      if (photos && photos.length > 0) {
        window.openPhotoLightbox(photos[startIndex], photos);
      }
    };

    /**
     * Open photo gallery lightbox
     * Shows all photos from the current report with navigation
     */
    window.openPhotoLightbox = function(clickedSrc, allPhotos = null) {
      // If we have the photos array, use it; otherwise just show single photo
      const photos = allPhotos || [clickedSrc];
      let currentIndex = 0;
      
      // Find the clicked photo index
      if (allPhotos) {
        currentIndex = allPhotos.findIndex(p => p === clickedSrc);
        if (currentIndex === -1) currentIndex = 0;
      }
      
      // Create lightbox overlay
      const lightbox = document.createElement('div');
      lightbox.id = 'photoLightbox';
      lightbox.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 999999;
      `;
      
      lightbox.innerHTML = `
        <button id="lightboxClose" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; width: 44px; height: 44px; border-radius: 50%; font-size: 24px; cursor: pointer; color: white; transition: background 0.2s;">√ó</button>
        
        <div id="lightboxCounter" style="position: absolute; top: 24px; left: 50%; transform: translateX(-50%); color: white; font-size: 14px; font-weight: 600; background: rgba(0,0,0,0.5); padding: 6px 16px; border-radius: 20px;">
          ${currentIndex + 1} / ${photos.length}
        </div>
        
        ${photos.length > 1 ? `
          <button id="lightboxPrev" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; cursor: pointer; color: white; transition: background 0.2s;">‚Äπ</button>
          <button id="lightboxNext" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; cursor: pointer; color: white; transition: background 0.2s;">‚Ä∫</button>
        ` : ''}
        
        <div id="lightboxMain" style="flex: 1; display: flex; align-items: center; justify-content: center; width: 100%; padding: 60px 80px; box-sizing: border-box;">
          <img id="lightboxImage" src="${photos[currentIndex]}" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; transition: opacity 0.2s;">
        </div>
        
        ${photos.length > 1 ? `
          <div id="lightboxThumbnails" style="display: flex; gap: 8px; padding: 16px; overflow-x: auto; max-width: 100%; background: rgba(0,0,0,0.5);">
            ${photos.map((photo, i) => `
              <img src="${photo}" data-index="${i}" class="lightbox-thumb" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; cursor: pointer; opacity: ${i === currentIndex ? '1' : '0.5'}; border: 2px solid ${i === currentIndex ? 'white' : 'transparent'}; transition: all 0.2s; flex-shrink: 0;">
            `).join('')}
          </div>
        ` : ''}
      `;
      
      document.body.appendChild(lightbox);
      document.body.style.overflow = 'hidden';
      
      const mainImage = document.getElementById('lightboxImage');
      const counter = document.getElementById('lightboxCounter');
      const thumbnails = document.querySelectorAll('.lightbox-thumb');
      
      // Update display function
      function showPhoto(index) {
        if (index < 0) index = photos.length - 1;
        if (index >= photos.length) index = 0;
        currentIndex = index;
        
        mainImage.style.opacity = '0.5';
        setTimeout(() => {
          mainImage.src = photos[currentIndex];
          mainImage.style.opacity = '1';
        }, 100);
        
        counter.textContent = `${currentIndex + 1} / ${photos.length}`;
        
        thumbnails.forEach((thumb, i) => {
          thumb.style.opacity = i === currentIndex ? '1' : '0.5';
          thumb.style.border = i === currentIndex ? '2px solid white' : '2px solid transparent';
        });
      }
      
      // Navigation
      document.getElementById('lightboxPrev')?.addEventListener('click', (e) => {
        e.stopPropagation();
        showPhoto(currentIndex - 1);
      });
      
      document.getElementById('lightboxNext')?.addEventListener('click', (e) => {
        e.stopPropagation();
        showPhoto(currentIndex + 1);
      });
      
      // Thumbnail clicks
      thumbnails.forEach(thumb => {
        thumb.addEventListener('click', (e) => {
          e.stopPropagation();
          showPhoto(parseInt(thumb.dataset.index));
        });
      });
      
      // Close button
      document.getElementById('lightboxClose').addEventListener('click', closeLightbox);
      
      // Click outside to close
      document.getElementById('lightboxMain').addEventListener('click', (e) => {
        if (e.target.id === 'lightboxMain') closeLightbox();
      });
      
      // Keyboard navigation
      function handleKeydown(e) {
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowLeft') showPhoto(currentIndex - 1);
        if (e.key === 'ArrowRight') showPhoto(currentIndex + 1);
      }
      document.addEventListener('keydown', handleKeydown);
      
      // Touch swipe support
      let touchStartX = 0;
      lightbox.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
      });
      lightbox.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const diff = touchStartX - touchEndX;
        if (Math.abs(diff) > 50) {
          if (diff > 0) showPhoto(currentIndex + 1);
          else showPhoto(currentIndex - 1);
        }
      });
      
      function closeLightbox() {
        document.removeEventListener('keydown', handleKeydown);
        document.body.style.overflow = '';
        lightbox.remove();
      }
    };
    
    // Store current report photos for gallery view
    let currentReportPhotos = [];

    /**
     * Zoom to report on map
     */
    window.zoomToReport = function(lat, lng) {
      document.getElementById('reportDetailModal').classList.add('hidden');
      map.setView([lat, lng], 16);
    };

    // ==========================================
    // CREATE REPORT MODAL FUNCTIONS
    // ==========================================
    
    let locationPickerMap = null;
    let locationPickerMarker = null;
    let pendingPhotos = [];

    /**
     * Open the create report modal
     */
    function openReportCreateModal() {
      const modal = document.getElementById('createReportModal');
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      // Initialize the location picker map
      setTimeout(() => {
        initLocationPickerMap();
      }, 100);
      
      // Reset form
      document.getElementById('createReportForm').reset();
      document.getElementById('photoPreviewGrid').innerHTML = '';
      pendingPhotos = [];
      
      // Set current location if available
      if (currentLocation) {
        setReportLocation(currentLocation.lat, currentLocation.lng);
      }
    }

    /**
     * Close the create report modal
     */
    window.closeCreateReportModal = function() {
      const modal = document.getElementById('createReportModal');
      modal.classList.add('hidden');
      modal.style.display = 'none';
      document.body.style.overflow = '';
      
      // Clean up the location picker map
      if (locationPickerMap) {
        locationPickerMap.remove();
        locationPickerMap = null;
        locationPickerMarker = null;
      }
    };

    /**
     * Initialize the location picker map
     */
    function initLocationPickerMap() {
      const container = document.getElementById('locationPickerMap');
      if (!container) return;
      
      // Clear any existing map
      if (locationPickerMap) {
        locationPickerMap.remove();
      }
      
      // Create mini map
      const startLat = currentLocation?.lat || -33.9249;
      const startLng = currentLocation?.lng || 18.4241;
      
      locationPickerMap = L.map('locationPickerMap').setView([startLat, startLng], 14);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OSM',
        maxZoom: 19
      }).addTo(locationPickerMap);
      
      // Add click handler to select location
      locationPickerMap.on('click', (e) => {
        setReportLocation(e.latlng.lat, e.latlng.lng);
      });
      
      // If we have current location, add marker
      if (currentLocation) {
        setReportLocation(currentLocation.lat, currentLocation.lng);
      }
    }

    /**
     * Set the report location
     */
    function setReportLocation(lat, lng) {
      document.getElementById('reportLat').value = lat;
      document.getElementById('reportLng').value = lng;
      document.getElementById('selectedLocationText').textContent = `Selected: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      
      // Update or create marker
      if (locationPickerMap) {
        if (locationPickerMarker) {
          locationPickerMarker.setLatLng([lat, lng]);
        } else {
          locationPickerMarker = L.marker([lat, lng], {
            icon: L.divIcon({
              html: '<div style="width: 24px; height: 24px; background: #ef4444; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
              className: 'location-marker',
              iconSize: [24, 24],
              iconAnchor: [12, 12]
            })
          }).addTo(locationPickerMap);
        }
        locationPickerMap.setView([lat, lng], 16);
      }
    }

    /**
     * Compress image to base64
     */
    function compressImage(file, maxWidth = 1200, quality = 0.7) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            const base64 = canvas.toDataURL('image/jpeg', quality);
            resolve({
              content: base64,
              originalName: file.name,
              originalSize: file.size,
              compressedSize: base64.length,
              uploadedAt: Date.now()
            });
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /**
     * Handle photo selection
     */
    async function handlePhotoSelection(files) {
      const previewGrid = document.getElementById('photoPreviewGrid');
      
      for (const file of files) {
        if (!file.type.startsWith('image/')) continue;
        
        try {
          const compressed = await compressImage(file);
          pendingPhotos.push(compressed);
          
          // Add preview
          const preview = document.createElement('div');
          preview.style.cssText = 'position: relative;';
          preview.innerHTML = `
            <img src="${compressed.content}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 8px;">
            <button type="button" onclick="removePhoto(${pendingPhotos.length - 1})" style="position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: #ef4444; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 14px;">√ó</button>
          `;
          previewGrid.appendChild(preview);
        } catch (error) {
          console.error('Error processing photo:', error);
        }
      }
    }

    /**
     * Remove a pending photo
     */
    window.removePhoto = function(index) {
      pendingPhotos.splice(index, 1);
      // Rebuild preview grid
      const previewGrid = document.getElementById('photoPreviewGrid');
      previewGrid.innerHTML = '';
      pendingPhotos.forEach((photo, i) => {
        const preview = document.createElement('div');
        preview.style.cssText = 'position: relative;';
        preview.innerHTML = `
          <img src="${photo.content}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 8px;">
          <button type="button" onclick="removePhoto(${i})" style="position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: #ef4444; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 14px;">√ó</button>
        `;
        previewGrid.appendChild(preview);
      });
    };

    /**
     * Submit the report
     */
    async function submitReport(e) {
      e.preventDefault();
      
      const lat = document.getElementById('reportLat').value;
      const lng = document.getElementById('reportLng').value;
      
      if (!lat || !lng) {
        alert('Please select a location on the map');
        return;
      }
      
      const issueType = document.getElementById('reportIssueType').value;
      if (!issueType) {
        alert('Please select an issue type');
        return;
      }
      
      const title = document.getElementById('reportTitle').value.trim();
      if (!title) {
        alert('Please enter a title');
        return;
      }
      
      const severity = document.querySelector('input[name="reportSeverity"]:checked')?.value || 'medium';
      const description = document.getElementById('reportDescription').value.trim();
      const address = document.getElementById('reportAddress').value.trim();
      
      // Disable submit button
      const submitBtn = document.getElementById('submitReportBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = '‚è≥ Submitting...';
      
      try {
        const reportData = {
          latitude: parseFloat(lat),
          longitude: parseFloat(lng),
          issueType,
          severity,
          title,
          description,
          address: address || null,
          photos: pendingPhotos,
          isPublic: true,
          status: 'new',
          upvotes: 0,
          upvotedBy: [],
          userId: currentUser.uid,
          userEmail: currentUser.email,
          userName: currentUser.displayName || currentUser.email?.split('@')[0] || 'Anonymous',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        
        // Save to Firestore
        const reportsRef = collection(db, 'accessibilityReports');
        const docRef = await addDoc(reportsRef, reportData);
        
        console.log('‚úÖ Report created:', docRef.id);
        
        // Close modal
        closeCreateReportModal();
        
        // Show success message
        showToast('Report submitted successfully!', 'success');
        
        // Reload reports
        await loadReports();
        
      } catch (error) {
        console.error('‚ùå Error creating report:', error);
        alert('Failed to submit report: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'üì§ Submit Report';
      }
    }

    /**
     * Show toast notification
     */
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 999999;
        animation: slideUp 0.3s ease-out;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideDown 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Add toast animations
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes slideUp {
        from { opacity: 0; transform: translateX(-50%) translateY(20px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
      }
      @keyframes slideDown {
        from { opacity: 1; transform: translateX(-50%) translateY(0); }
        to { opacity: 0; transform: translateX(-50%) translateY(20px); }
      }
    `;
    document.head.appendChild(toastStyle);

    /**
     * Setup event listeners
     */
    function setupEventListeners() {
      // Apply filters
      document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);

      // Reset filters
      document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);

      // Use my location
      document.getElementById('useMyLocationBtn').addEventListener('click', async () => {
        await getUserLocation();
        if (currentLocation) {
          filterByProximity(currentLocation, 50);
        }
      });

      // Center map
      document.getElementById('centerMapBtn').addEventListener('click', () => {
        if (currentLocation) {
          map.setView([currentLocation.lat, currentLocation.lng], 13);
        }
      });

      // Fullscreen toggle
      document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);

      // Report FAB - open create modal
      document.getElementById('reportFabBtn').addEventListener('click', () => {
        if (!currentUser) {
          alert('Please sign in to report an accessibility issue');
          return;
        }
        openReportCreateModal();
      });

      // Create report modal events
      document.getElementById('closeCreateModalBtn').addEventListener('click', closeCreateReportModal);
      
      document.getElementById('createReportModal').addEventListener('click', (e) => {
        if (e.target.id === 'createReportModal') {
          closeCreateReportModal();
        }
      });
      
      document.getElementById('useCurrentLocationBtn').addEventListener('click', async () => {
        if (currentLocation) {
          setReportLocation(currentLocation.lat, currentLocation.lng);
        } else {
          await getUserLocation();
          if (currentLocation) {
            setReportLocation(currentLocation.lat, currentLocation.lng);
          }
        }
      });
      
      document.getElementById('addPhotosBtn').addEventListener('click', () => {
        document.getElementById('reportPhotos').click();
      });
      
      document.getElementById('reportPhotos').addEventListener('change', (e) => {
        handlePhotoSelection(e.target.files);
      });
      
      document.getElementById('createReportForm').addEventListener('submit', submitReport);

      // Modal close
      document.getElementById('closeModalBtn').addEventListener('click', () => {
        document.getElementById('reportDetailModal').classList.add('hidden');
      });

      // Close modal on backdrop click
      document.getElementById('reportDetailModal').addEventListener('click', (e) => {
        if (e.target.id === 'reportDetailModal') {
          document.getElementById('reportDetailModal').classList.add('hidden');
        }
      });

      // Close modal on Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          document.getElementById('reportDetailModal').classList.add('hidden');
        }
      });

      // Mobile menu toggle
      const menuToggle = document.getElementById('menuToggle');
      const navMenu = document.getElementById('navMenu');
      if (menuToggle && navMenu) {
        menuToggle.addEventListener('click', () => {
          navMenu.classList.toggle('active');
          menuToggle.classList.toggle('active');
        });

        navMenu.querySelectorAll('a.nav-link').forEach(link => {
          link.addEventListener('click', () => {
            navMenu.classList.remove('active');
            menuToggle.classList.remove('active');
          });
        });
      }

      // Auth button
      const navAuthBtn = document.getElementById('navAuthBtn');
      if (navAuthBtn) {
        navAuthBtn.addEventListener('click', async () => {
          if (currentUser) {
            if (confirm('Sign out of Access Nature?')) {
              await signOut(auth);
            }
          } else {
            const provider = new GoogleAuthProvider();
            try {
              await signInWithPopup(auth, provider);
            } catch (error) {
              console.error('Sign in error:', error);
              alert('Sign in failed. Please try again.');
            }
          }
        });
      }
    }

    /**
     * Update auth UI
     */
    function updateAuthUI(user) {
      const navAuthBtn = document.getElementById('navAuthBtn');
      const indicator = document.getElementById('navAuthIndicator');
      const statusText = document.getElementById('navAuthStatusText');
      
      if (user) {
        if (navAuthBtn) navAuthBtn.textContent = 'Sign Out';
        if (indicator) indicator.classList.add('signed-in');
        if (statusText) statusText.textContent = user.displayName || user.email?.split('@')[0] || 'User';
      } else {
        if (navAuthBtn) navAuthBtn.textContent = 'Sign In';
        if (indicator) indicator.classList.remove('signed-in');
        if (statusText) statusText.textContent = 'Guest';
      }
    }

    /**
     * Apply filters
     */
    function applyFilters() {
      const status = document.getElementById('statusFilter').value;
      const severity = document.getElementById('severityFilter').value;
      const type = document.getElementById('typeFilter').value;

      filteredReports = allReports.filter(report => {
        if (status && report.status !== status) return false;
        if (severity && report.severity !== severity) return false;
        if (type && report.issueType !== type) return false;
        return true;
      });

      displayReports();
      console.log(`üîç Filtered to ${filteredReports.length} reports`);
    }

    /**
     * Reset filters
     */
    function resetFilters() {
      document.getElementById('statusFilter').value = '';
      document.getElementById('severityFilter').value = '';
      document.getElementById('typeFilter').value = '';

      filteredReports = allReports;
      displayReports();
    }

    /**
     * Filter by proximity
     */
    function filterByProximity(location, radiusKm) {
      filteredReports = allReports.filter(report => {
        const lat = report.latitude || report.location?.latitude;
        const lng = report.longitude || report.location?.longitude;
        if (!lat || !lng) return false;

        const distance = calculateDistance(location.lat, location.lng, lat, lng);
        return distance <= radiusKm;
      });

      displayReports();
      console.log(`üîç Filtered to ${filteredReports.length} reports within ${radiusKm}km`);
    }

    /**
     * Calculate distance between two coordinates (Haversine formula)
     */
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth's radius in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    /**
     * Navigate to location using Waze or Google Maps
     */
    window.navigateToLocation = function(lat, lng) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999999;
      `;
      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 24px; max-width: 320px; width: 90%; text-align: center;">
          <h3 style="margin: 0 0 16px 0; font-size: 1.25rem;">üß≠ Navigate to Location</h3>
          <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 20px;">Choose your preferred navigation app:</p>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <a href="https://waze.com/ul?ll=${lat},${lng}&navigate=yes" target="_blank" 
               style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px; background: #33ccff; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1rem;">
              <span style="font-size: 1.5rem;">üöó</span> Open in Waze
            </a>
            <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank"
               style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px; background: #4285f4; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1rem;">
              <span style="font-size: 1.5rem;">üó∫Ô∏è</span> Open in Google Maps
            </a>
            <a href="https://maps.apple.com/?daddr=${lat},${lng}" target="_blank"
               style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px; background: #333; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1rem;">
              <span style="font-size: 1.5rem;">üçé</span> Open in Apple Maps
            </a>
          </div>
          <button onclick="this.closest('div').parentElement.remove()" 
                  style="margin-top: 16px; padding: 10px 24px; background: #f3f4f6; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #374151;">
            Cancel
          </button>
        </div>
      `;
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      document.body.appendChild(modal);
    };

    /**
     * Toggle fullscreen map with proper modal
     */
    function toggleFullscreen() {
      const mapSection = document.querySelector('.map-section');
      const mapElement = document.getElementById('reportMap');
      const btn = document.getElementById('fullscreenBtn');

      if (document.getElementById('fullscreenMapModal')) {
        // Close fullscreen
        closeFullscreenMap();
      } else {
        // Open fullscreen modal
        openFullscreenMap();
      }
    }

    /**
     * Open fullscreen map modal
     */
    function openFullscreenMap() {
      const modal = document.createElement('div');
      modal.id = 'fullscreenMapModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.9);
        z-index: 99999;
        display: flex;
        flex-direction: column;
      `;
      
      modal.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: white; border-bottom: 1px solid #e5e7eb;">
          <h2 style="margin: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 8px;">
            üó∫Ô∏è Accessibility Reports Map
          </h2>
          <div style="display: flex; gap: 8px; align-items: center;">
            <span style="font-size: 0.875rem; color: #6b7280;">${filteredReports.length} reports</span>
            <button id="closeFullscreenMapBtn" style="width: 40px; height: 40px; background: #f3f4f6; border: none; border-radius: 8px; cursor: pointer; font-size: 1.25rem; display: flex; align-items: center; justify-content: center;">‚úï</button>
          </div>
        </div>
        <div id="fullscreenMapContainer" style="flex: 1; position: relative;"></div>
      `;
      
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
      
      // Move map to fullscreen container
      const mapElement = document.getElementById('reportMap');
      const originalParent = mapElement.parentElement;
      const fullscreenContainer = document.getElementById('fullscreenMapContainer');
      
      // Store original parent for restoration
      window.originalMapParent = originalParent;
      
      // Move map
      fullscreenContainer.appendChild(mapElement);
      mapElement.style.height = '100%';
      mapElement.style.borderRadius = '0';
      
      // Update map size
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
      
      // Update button
      document.getElementById('fullscreenBtn').textContent = '‚úï';
      
      // Close button handler
      document.getElementById('closeFullscreenMapBtn').addEventListener('click', closeFullscreenMap);
      
      // ESC key handler
      const escHandler = (e) => {
        if (e.key === 'Escape') {
          closeFullscreenMap();
          document.removeEventListener('keydown', escHandler);
        }
      };
      document.addEventListener('keydown', escHandler);
    }

    /**
     * Close fullscreen map modal
     */
    function closeFullscreenMap() {
      const modal = document.getElementById('fullscreenMapModal');
      if (!modal) return;
      
      const mapElement = document.getElementById('reportMap');
      
      // Move map back to original location
      if (window.originalMapParent) {
        window.originalMapParent.appendChild(mapElement);
        mapElement.style.height = '500px';
        mapElement.style.borderRadius = '8px';
      }
      
      // Remove modal
      modal.remove();
      document.body.style.overflow = '';
      
      // Update button
      document.getElementById('fullscreenBtn').textContent = '‚õ∂';
      
      // Update map size
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    }

    /**
     * Escape HTML
     */
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }


    console.log('üìÑ Reports page script loaded');
  </script>
</body>
</html>